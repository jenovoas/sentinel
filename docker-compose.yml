services:
  # PostgreSQL Database
  postgres:
    image: postgres:16-alpine
    container_name: sentinel-postgres
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-sentinel_user}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-darkfenix}
      POSTGRES_DB: ${POSTGRES_DB:-sentinel_db}
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./docker/postgres/init.sql:/docker-entrypoint-initdb.d/init.sql
    networks:
      - sentinel_network
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-sentinel_user}" ]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  # Redis Cache & Message Broker
  redis:
    image: redis:7-alpine
    container_name: sentinel-redis
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    networks:
      - sentinel_network
    command: redis-server --appendonly yes
    healthcheck:
      test: [ "CMD", "redis-cli", "ping" ]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  # FastAPI Backend
  backend:
    build:
      context: .
      dockerfile: backend/Dockerfile
    container_name: sentinel-backend
    environment:
      DATABASE_URL: ${DATABASE_URL:-postgresql+asyncpg://sentinel_user:darkfenix@postgres:5432/sentinel_db}
      REDIS_URL: ${REDIS_URL:-redis://redis:6379/0}
      FASTAPI_ENV: ${FASTAPI_ENV:-development}
      SECRET_KEY: ${SECRET_KEY:-your-secret-key-change-in-production-min-32-chars-xyz123}
      ALGORITHM: ${ALGORITHM:-HS256}
      ACCESS_TOKEN_EXPIRE_MINUTES: ${ACCESS_TOKEN_EXPIRE_MINUTES:-30}
      REFRESH_TOKEN_EXPIRE_DAYS: ${REFRESH_TOKEN_EXPIRE_DAYS:-7}
      ALLOWED_ORIGINS: ${ALLOWED_ORIGINS:-http://localhost:3000,http://localhost:8000,http://frontend:3000}
      CELERY_BROKER_URL: ${CELERY_BROKER_URL:-redis://redis:6379/0}
      CELERY_RESULT_BACKEND: ${CELERY_RESULT_BACKEND:-redis://redis:6379/1}
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
    ports:
      - "8000:8000"
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    volumes:
      - ./backend:/app
    networks:
      - sentinel_network
    command: uvicorn app.main:app --host 0.0.0.0 --port 8000 --reload
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8000/api/v1/health" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    restart: unless-stopped

  # Celery Worker
  celery_worker:
    build:
      context: .
      dockerfile: backend/Dockerfile.worker
    container_name: sentinel-celery-worker
    environment:
      DATABASE_URL: ${DATABASE_URL:-postgresql+asyncpg://sentinel_user:darkfenix@postgres:5432/sentinel_db}
      REDIS_URL: ${REDIS_URL:-redis://redis:6379/0}
      CELERY_BROKER_URL: ${CELERY_BROKER_URL:-redis://redis:6379/0}
      CELERY_RESULT_BACKEND: ${CELERY_RESULT_BACKEND:-redis://redis:6379/1}
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
    depends_on:
      - postgres
      - redis
    volumes:
      - ./backend:/app
    networks:
      - sentinel_network
    command: celery -A app.celery_app worker --loglevel=info --concurrency=4
    restart: unless-stopped

  # Celery Beat (Scheduler)
  celery_beat:
    build:
      context: .
      dockerfile: backend/Dockerfile.beat
    container_name: sentinel-celery-beat
    environment:
      DATABASE_URL: ${DATABASE_URL:-postgresql+asyncpg://sentinel_user:darkfenix@postgres:5432/sentinel_db}
      REDIS_URL: ${REDIS_URL:-redis://redis:6379/0}
      CELERY_BROKER_URL: ${CELERY_BROKER_URL:-redis://redis:6379/0}
      CELERY_RESULT_BACKEND: ${CELERY_RESULT_BACKEND:-redis://redis:6379/1}
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
    depends_on:
      - postgres
      - redis
    volumes:
      - ./backend:/app
    networks:
      - sentinel_network
    command: celery -A app.celery_app beat --loglevel=info
    restart: unless-stopped

  # Next.js Frontend (Development)
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile.dev
    container_name: sentinel-frontend
    environment:
      NEXT_PUBLIC_API_URL: ${NEXT_PUBLIC_API_URL:-http://localhost:8000}
      NODE_ENV: ${NODE_ENV:-development}
    ports:
      - "3000:3000"
    depends_on:
      - backend
    volumes:
      - ./frontend/src:/app/src
      - ./frontend/public:/app/public
      - ./frontend/next.config.js:/app/next.config.js
      - ./host-metrics:/app/host-metrics:ro
    networks:
      - sentinel_network
    command: npm run dev
    restart: unless-stopped

  # Nginx Reverse Proxy
  nginx:
    build:
      context: .
      dockerfile: docker/nginx/Dockerfile
    container_name: sentinel-nginx
    ports:
      - "80:80"
      - "443:443"
    depends_on:
      - backend
      - frontend
    volumes:
      - ./docker/nginx/nginx.conf:/etc/nginx/conf.d/default.conf:ro
    networks:
      - sentinel_network
    healthcheck:
      test: [ "CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost/api/v1/health" ]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped

  # ========================================
  # OBSERVABILITY STACK
  # ========================================

  # Node Exporter - Host Metrics
  node-exporter:
    image: prom/node-exporter:latest
    container_name: sentinel-node-exporter
    command:
      - '--path.rootfs=/host'
      - '--path.procfs=/host/proc'
      - '--path.sysfs=/host/sys'
      - '--collector.filesystem.mount-points-exclude=^/(sys|proc|dev|host|etc)($$|/)'
      - '--collector.systemd'
      - '--collector.processes'
    volumes:
      - /:/host:ro,rslave
      - /proc:/host/proc:ro
      - /sys:/host/sys:ro
    ports:
      - "9100:9100"
    networks:
      - sentinel_network
    restart: unless-stopped
    pid: host

  # PostgreSQL Exporter
  postgres-exporter:
    image: prometheuscommunity/postgres-exporter:latest
    container_name: sentinel-postgres-exporter
    environment:
      DATA_SOURCE_NAME: "postgresql://sentinel_user:darkfenix@postgres:5432/sentinel_db?sslmode=disable"
    ports:
      - "9187:9187"
    networks:
      - sentinel_network
    depends_on:
      - postgres
    restart: unless-stopped

  # Redis Exporter
  redis-exporter:
    image: oliver006/redis_exporter:latest
    container_name: sentinel-redis-exporter
    environment:
      REDIS_ADDR: redis:6379
    ports:
      - "9121:9121"
    networks:
      - sentinel_network
    depends_on:
      - redis
    restart: unless-stopped

  # Prometheus - Metrics Storage & Queries
  prometheus:
    image: prom/prometheus:latest
    container_name: sentinel-prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--storage.tsdb.retention.time=90d'
      - '--storage.tsdb.retention.size=10GB'
      - '--web.console.libraries=/usr/share/prometheus/console_libraries'
      - '--web.console.templates=/usr/share/prometheus/consoles'
      - '--web.enable-lifecycle'
      - '--web.enable-admin-api'
    volumes:
      - ./observability/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - ./observability/prometheus/rules:/etc/prometheus/rules:ro
      - prometheus_data:/prometheus
    ports:
      - "9090:9090"
    networks:
      - sentinel_network
    depends_on:
      - node-exporter
    restart: unless-stopped

  # Loki - Log Aggregation
  loki:
    image: grafana/loki:latest
    container_name: sentinel-loki
    command: -config.file=/etc/loki/loki-config.yml
    volumes:
      - ./observability/loki/loki-config.yml:/etc/loki/loki-config.yml:ro
      - loki_data:/loki
    ports:
      - "3100:3100"
    networks:
      - sentinel_network
    restart: unless-stopped

  # Promtail - Log Collector
  promtail:
    image: grafana/promtail:latest
    container_name: sentinel-promtail
    command: -config.file=/etc/promtail/promtail-config.yml
    volumes:
      - ./observability/promtail/promtail-config.yml:/etc/promtail/promtail-config.yml:ro
      - /var/log:/var/log:ro
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./host-metrics:/host-metrics:ro
    ports:
      - "9080:9080"
    networks:
      - sentinel_network
    depends_on:
      - loki
    restart: unless-stopped

  # Grafana - Visualization & Dashboards
  grafana:
    image: grafana/grafana:latest
    container_name: sentinel-grafana
    environment:
      GF_SECURITY_ADMIN_USER: ${GRAFANA_USER:-admin}
      GF_SECURITY_ADMIN_PASSWORD: ${GRAFANA_PASSWORD:-darkfenix}
      GF_INSTALL_PLUGINS: grafana-clock-panel
      GF_SERVER_ROOT_URL: http://localhost:3001
      GF_PATHS_PROVISIONING: /etc/grafana/provisioning
      GF_AUTH_ANONYMOUS_ENABLED: false
      GF_ANALYTICS_REPORTING_ENABLED: false
      GF_ANALYTICS_CHECK_FOR_UPDATES: false
    volumes:
      - ./observability/grafana/provisioning:/etc/grafana/provisioning:ro
      - grafana_data:/var/lib/grafana
    ports:
      - "3001:3000"
    networks:
      - sentinel_network
    depends_on:
      - prometheus
      - loki
    restart: unless-stopped

  # n8n - Automation Workflows
  n8n:
    image: n8nio/n8n:latest
    container_name: sentinel-n8n
    environment:
      GENERIC_TIMEZONE: America/Santiago
      N8N_BASIC_AUTH_ACTIVE: ${N8N_BASIC_AUTH_ACTIVE:-true}
      N8N_BASIC_AUTH_USER: ${N8N_USER:-admin}
      N8N_BASIC_AUTH_PASSWORD: ${N8N_PASSWORD:-darkfenix}
      N8N_HOST: ${N8N_HOST:-localhost}
      N8N_PORT: 5678
      N8N_PROTOCOL: http
      WEBHOOK_URL: http://localhost:5678/
      N8N_EDITOR_BASE_URL: http://localhost:5678/
      EXECUTIONS_DATA_PRUNE: true
      EXECUTIONS_DATA_MAX_AGE: 168
      # ðŸ”“ EDUCATIVO: Permite API calls sin API Key (solo con Basic Auth)
      N8N_API_KEY_REQUIRED: "false"
    ports:
      - "5678:5678"
    volumes:
      - n8n_data:/home/node/.n8n
    networks:
      - sentinel_network
    # âš•ï¸ ESTRATEGIA 3: Healthcheck para auto-loader
    healthcheck:
      test: [ "CMD-SHELL", "wget --spider -q http://localhost:5678 || exit 1" ]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    restart: unless-stopped

  # ðŸ¤– ESTRATEGIA 3: Auto-loader de workflows
  # Este servicio se ejecuta SOLO cuando n8n estÃ¡ "healthy"
  n8n-loader:
    build:
      context: ./docker/n8n
      dockerfile: Dockerfile.loader
    container_name: sentinel-n8n-loader
    volumes:
      - ./docker/n8n/workflows:/workflows:ro
    networks:
      - sentinel_network
    depends_on:
      n8n:
        condition: service_healthy
    restart: "no" # Solo ejecuta una vez

  # ========================================
  # AI STACK - Local LLM with Ollama
  # ========================================

  # Ollama - Local AI Engine
  ollama:
    image: ollama/ollama:latest
    container_name: sentinel-ollama
    ports:
      - "11434:11434"
    volumes:
      - ollama_data:/root/.ollama
    networks:
      - sentinel_network
    environment:
      - OLLAMA_HOST=0.0.0.0
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:11434/api/tags" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    restart: unless-stopped
    # GPU support for NVIDIA GTX 1050 (3GB VRAM)
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [ gpu ]
    # Ollama Model Loader - Downloads models on first run
  ollama-init:
    image: ollama/ollama:latest
    container_name: sentinel-ollama-init
    volumes:
      - ollama_data:/root/.ollama
    networks:
      - sentinel_network
    depends_on:
      ollama:
        condition: service_healthy
    command: >
      sh -c "echo 'ðŸ“¥ Downloading AI models...' &&
             ollama pull phi3:mini &&
             echo 'âœ… phi3:mini downloaded successfully' &&
             ollama pull llama3.2:1b &&
             echo 'âœ… llama3.2:1b downloaded successfully' &&
             echo 'ðŸŽ‰ All models ready!'"
    restart: "no" # Solo ejecuta una vez

volumes:
  postgres_data:
    driver: local
  redis_data:
    driver: local
  prometheus_data:
    driver: local
  loki_data:
    driver: local
  grafana_data:
    driver: local
  n8n_data:
    driver: local
  ollama_data:
    driver: local

networks:
  sentinel_network:
    driver: bridge
